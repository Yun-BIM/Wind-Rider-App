<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>歷史記錄</title>
    <style>
        /* 這裡只包含 iframe 內獨有的或覆蓋的樣式 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: transparent;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        .section-title {
            font-size: 24px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
        }

        .history-panel {
            margin-top: 0; /* 在 iframe 內，這個 margin 就不需要了 */
            background: #f7fafc;
            border-radius: 12px;
            padding: 10px;
            border: 1px solid #e2e8f0;
            min-height: 200px; /* 最小高度確保顯示效果 */
        }

        .history-item {
            padding: 10px 5px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 14px;
            line-height: 1.4;
            color: #2d3748;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-item-date {
            font-size: 12px;
            color: #718096;
            margin-bottom: 4px;
        }

        .history-item-type {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .history-item-content {
            color: #4a5568;
        }

        /* 訊息提示框的動畫 CSS */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- 這裡的內容是歷史頁面專屬的 -->
    <h2 class="section-title">歷史記錄</h2>
    
    <div id="historyPanel" class="history-panel">
        <!-- 歷史記錄將在這裡動態載入 -->
    </div>

    <script>
        // IndexedDB 資料庫初始化 (此 iframe 獨立操作)
        let db;
        const DB_NAME = 'WindRiderDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'records';

        /**
         * 初始化 IndexedDB 資料庫。
         */
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    console.log('History iframe: IndexedDB 連接成功');
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const store = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                        store.createIndex('createdAt', 'createdAt', { unique: false });
                        store.createIndex('journalType', 'journalType', { unique: false });
                        store.createIndex('creator', 'creator', { unique: false });
                        console.log('History iframe: Object Store 已創建');
                    }
                };
            });
        }

        /**
         * 從 IndexedDB 獲取所有記錄。
         */
        async function getAllRecords() {
            if (!db) {
                await initDB();
            }
            return new Promise((resolve, reject) => {
                const tx = db.transaction([STORE_NAME], 'readonly');
                const store = tx.objectStore(STORE_NAME);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result || []);
                request.onerror = () => reject(request.error);
            });
        }

        /**
         * 顯示應用程式訊息 (成功或錯誤)。
         */
        function showMessage(message, type = 'success') {
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 1000;
                animation: slideIn 0.3s ease;
                ${type === 'success' ? 'background: #48bb78;' : 'background: #f56565;'}
            `;
            messageDiv.textContent = message;
            // 將訊息添加到父視窗的 body，因為 iframe 自身的 body 可能太小
            if (window.parent && window.parent.document) {
                window.parent.document.body.appendChild(messageDiv);
            } else {
                document.body.appendChild(messageDiv);
            }
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        /**
         * 顯示最近五筆歷史記錄到歷史面板。
         */
        async function showHistory() {
            const panel = document.getElementById('historyPanel');
            panel.innerHTML = ''; // 清空舊內容

            try {
                const records = await getAllRecords();
                records.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                const latestFive = records.slice(0, 5);

                if (latestFive.length === 0) {
                    const noRecordDiv = document.createElement('div');
                    noRecordDiv.className = 'history-item';
                    noRecordDiv.textContent = '尚無記錄';
                    noRecordDiv.style.textAlign = 'center';
                    noRecordDiv.style.color = '#718096';
                    panel.appendChild(noRecordDiv);
                } else {
                    const typeMap = {
                        navigation_log: '航行日誌',
                        trigger_event: '觸發型事件記錄',
                        diary_mapping: '日記映射'
                    };

                    latestFive.forEach(r => {
                        const item = document.createElement('div');
                        item.className = 'history-item';

                        const dateObj = new Date(r.createdAt);
                        const dateStr = dateObj.toLocaleString('zh-TW', { 
                            year: 'numeric', 
                            month: '2-digit', 
                            day: '2-digit', 
                            hour: '2-digit', 
                            minute: '2-digit', 
                            second: '2-digit',
                            hour12: false
                        });

                        const contentAbstract = r.recordText.length > 20 
                            ? r.recordText.substring(0, 20) + '...' 
                            : r.recordText;

                        item.innerHTML = `
                            <div class="history-item-date">${dateStr}</div>
                            <div class="history-item-type">${typeMap[r.journalType] || r.journalType}</div>
                            <div class="history-item-content">${contentAbstract}</div>
                        `;
                        panel.appendChild(item);
                    });
                }
            } catch (error) {
                console.error('History iframe: 顯示歷史記錄失敗:', error);
                const errorDiv = document.createElement('div');
                errorDiv.className = 'history-item';
                errorDiv.style.color = '#f56565';
                errorDiv.textContent = '載入歷史記錄時發生錯誤。';
                panel.appendChild(errorDiv);
            }
        }

        // 頁面載入時初始化並顯示歷史記錄
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                await initDB();
                await showHistory(); // 載入時立即顯示歷史記錄
                console.log('History iframe: 頁面初始化完成並已顯示歷史記錄');
            } catch (error) {
                console.error('History iframe: 初始化失敗:', error);
                showMessage('歷史頁面初始化失敗', 'error');
            }
        });
    </script>
</body>
</html>
